<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Báo cáo hàng ngày</title>
    
    <th:block layout:fragment="head">
        <style>
            .report-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 12px;
                margin-bottom: 20px;
            }
            
            .report-header h2 {
                margin: 0;
                font-weight: 700;
            }
            
            .summary-item {
                background: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .summary-item h3 {
                font-size: 2.5rem;
                font-weight: 700;
                margin: 10px 0 5px;
            }
            
            .incident-timeline {
                position: relative;
                padding-left: 40px;
            }
            
            .incident-timeline::before {
                content: '';
                position: absolute;
                left: 15px;
                top: 0;
                bottom: 0;
                width: 3px;
                background: #e9ecef;
            }
            
            .timeline-entry {
                position: relative;
                padding-bottom: 25px;
            }
            
            .timeline-entry::before {
                content: '';
                position: absolute;
                left: -32px;
                top: 5px;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #6c757d;
                border: 3px solid white;
            }
            
            .timeline-entry.status-detected::before { background: #dc3545; }
            .timeline-entry.status-confirmed::before { background: #ffc107; }
            .timeline-entry.status-resolved::before { background: #28a745; }
            
            .timeline-card {
                background: white;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                border-left: 4px solid #6c757d;
            }
            
            .timeline-card.status-detected { border-left-color: #dc3545; }
            .timeline-card.status-confirmed { border-left-color: #ffc107; }
            .timeline-card.status-resolved { border-left-color: #28a745; }
            
            .print-btn {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
            }
            
            @media print {
                .no-print { display: none !important; }
                .content-wrapper { margin-left: 0 !important; }
                .main-sidebar { display: none !important; }
                .main-header { display: none !important; }
            }
        </style>
    </th:block>
</head>

<body>
    <th:block layout:fragment="content-header">
        <div class="content-header no-print">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">
                            <i class="fas fa-file-alt text-info mr-2"></i>Báo cáo hàng ngày
                        </h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                            <li class="breadcrumb-item"><a href="#">Báo cáo</a></li>
                            <li class="breadcrumb-item active">Hàng ngày</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <th:block layout:fragment="content">
        <!-- Date Selector -->
        <div class="card no-print">
            <div class="card-body">
                <form class="form-inline" id="dateForm">
                    <label class="mr-2"><i class="fas fa-calendar-day mr-1"></i>Chọn ngày:</label>
                    <input type="date" class="form-control mr-2" id="reportDate">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-1"></i>Xem báo cáo
                    </button>
                    <button type="button" class="btn btn-secondary ml-2" onclick="setToday()">Hôm nay</button>
                    <button type="button" class="btn btn-secondary ml-1" onclick="setYesterday()">Hôm qua</button>
                </form>
            </div>
        </div>

        <!-- Report Content -->
        <div id="reportContent">
            <!-- Report Header -->
            <div class="report-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-1">BÁO CÁO SỰ CỐ GIAO THÔNG</p>
                        <h2 id="reportTitle">Ngày --/--/----</h2>
                        <p class="mb-0 mt-2">
                            <i class="fas fa-clock mr-1"></i>Tạo lúc: <span id="generatedAt"></span>
                        </p>
                    </div>
                    <div class="col-md-4 text-md-right">
                        <img src="https://via.placeholder.com/100x60?text=LOGO" alt="Logo" class="img-fluid">
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="summary-item">
                        <i class="fas fa-car-crash text-primary fa-2x"></i>
                        <h3 id="summaryTotal">0</h3>
                        <p class="text-muted mb-0">Tổng sự cố</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <i class="fas fa-exclamation-circle text-danger fa-2x"></i>
                        <h3 id="summaryDetected">0</h3>
                        <p class="text-muted mb-0">Mới phát hiện</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <i class="fas fa-spinner text-warning fa-2x"></i>
                        <h3 id="summaryConfirmed">0</h3>
                        <p class="text-muted mb-0">Đang xử lý</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-item">
                        <i class="fas fa-check-circle text-success fa-2x"></i>
                        <h3 id="summaryResolved">0</h3>
                        <p class="text-muted mb-0">Đã xử lý</p>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history mr-2"></i>Diễn biến sự cố trong ngày</h3>
                </div>
                <div class="card-body">
                    <div class="incident-timeline" id="incidentTimeline">
                        <p class="text-muted text-center py-4">Không có sự cố nào trong ngày này</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-table mr-2"></i>Chi tiết sự cố</h3>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>ID</th>
                                <th>Thời gian</th>
                                <th>Mô tả</th>
                                <th>Vị trí</th>
                                <th>Trạng thái</th>
                                <th>Thời gian XL</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-sticky-note mr-2"></i>Ghi chú</h3>
                </div>
                <div class="card-body">
                    <textarea class="form-control no-print" rows="4" 
                              placeholder="Thêm ghi chú cho báo cáo..."></textarea>
                    <p class="text-muted mt-2 mb-0">
                        <i class="fas fa-info-circle mr-1"></i>
                        Báo cáo được tạo tự động bởi hệ thống ITS
                    </p>
                </div>
            </div>
        </div>

        <!-- Print Button -->
        <button class="btn btn-lg btn-primary rounded-circle print-btn no-print" onclick="window.print()">
            <i class="fas fa-print"></i>
        </button>
    </th:block>

    <th:block layout:fragment="scripts">
        <script>
            let reportIncidents = [];
            
            document.addEventListener('DOMContentLoaded', function() {
                setToday();
            });
            
            function setToday() {
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                loadReport();
            }
            
            function setYesterday() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                document.getElementById('reportDate').value = yesterday.toISOString().split('T')[0];
                loadReport();
            }
            
            document.getElementById('dateForm').addEventListener('submit', function(e) {
                e.preventDefault();
                loadReport();
            });
            
            function loadReport() {
                const date = document.getElementById('reportDate').value;
                
                fetch('/api/incidents', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(response => response.json())
                .then(data => {
                    // Filter by selected date
                    reportIncidents = data.filter(i => {
                        const incidentDate = new Date(i.detectionTime).toISOString().split('T')[0];
                        return incidentDate === date;
                    });
                    
                    // Sort by time
                    reportIncidents.sort((a, b) => new Date(a.detectionTime) - new Date(b.detectionTime));
                    
                    renderReport(date);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Lỗi tải dữ liệu', 'error');
                });
            }
            
            function renderReport(date) {
                // Update header
                const reportDate = new Date(date);
                document.getElementById('reportTitle').textContent = 
                    `Ngày ${reportDate.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                document.getElementById('generatedAt').textContent = new Date().toLocaleString('vi-VN');
                
                // Update summary
                const detected = reportIncidents.filter(i => i.status === 'DETECTED').length;
                const confirmed = reportIncidents.filter(i => i.status === 'CONFIRMED').length;
                const resolved = reportIncidents.filter(i => i.status === 'RESOLVED').length;
                
                document.getElementById('summaryTotal').textContent = reportIncidents.length;
                document.getElementById('summaryDetected').textContent = detected;
                document.getElementById('summaryConfirmed').textContent = confirmed;
                document.getElementById('summaryResolved').textContent = resolved;
                
                // Render timeline
                renderTimeline();
                
                // Render table
                renderTable();
            }
            
            function renderTimeline() {
                const timeline = document.getElementById('incidentTimeline');
                
                if (reportIncidents.length === 0) {
                    timeline.innerHTML = '<p class="text-muted text-center py-4">Không có sự cố nào trong ngày này</p>';
                    return;
                }
                
                timeline.innerHTML = reportIncidents.map(i => {
                    const statusClass = `status-${i.status.toLowerCase()}`;
                    const statusText = {
                        'DETECTED': 'Phát hiện sự cố',
                        'CONFIRMED': 'Đã xác nhận',
                        'RESOLVED': 'Đã xử lý xong'
                    };
                    
                    return `
                        <div class="timeline-entry ${statusClass}">
                            <div class="timeline-card ${statusClass}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <strong>
                                        <i class="far fa-clock mr-1"></i>
                                        ${new Date(i.detectionTime).toLocaleTimeString('vi-VN')}
                                    </strong>
                                    <span class="badge badge-${i.status === 'RESOLVED' ? 'success' : i.status === 'CONFIRMED' ? 'warning' : 'danger'}">
                                        ${statusText[i.status]}
                                    </span>
                                </div>
                                <p class="mb-1"><strong>#${i.id}</strong> - ${escapeHtml(i.description)}</p>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    ${i.latitude.toFixed(4)}, ${i.longitude.toFixed(4)}
                                    ${i.resolutionTime ? `<span class="ml-3"><i class="fas fa-check-double mr-1"></i>Xử lý lúc: ${new Date(i.resolutionTime).toLocaleTimeString('vi-VN')}</span>` : ''}
                                </small>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function renderTable() {
                const tbody = document.getElementById('detailTableBody');
                
                if (reportIncidents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có dữ liệu</td></tr>';
                    return;
                }
                
                tbody.innerHTML = reportIncidents.map(i => {
                    const statusBadge = {
                        'DETECTED': '<span class="badge badge-danger">Mới</span>',
                        'CONFIRMED': '<span class="badge badge-warning">Đang XL</span>',
                        'RESOLVED': '<span class="badge badge-success">Hoàn tất</span>'
                    };
                    
                    let resolutionTime = '--';
                    if (i.resolutionTime && i.detectionTime) {
                        const minutes = Math.round((new Date(i.resolutionTime) - new Date(i.detectionTime)) / 60000);
                        if (minutes < 60) {
                            resolutionTime = `${minutes} phút`;
                        } else {
                            resolutionTime = `${Math.floor(minutes/60)}h ${minutes%60}p`;
                        }
                    }
                    
                    return `
                        <tr>
                            <td><a href="/incidents/${i.id}">#${i.id}</a></td>
                            <td>${new Date(i.detectionTime).toLocaleTimeString('vi-VN')}</td>
                            <td>${escapeHtml(i.description)}</td>
                            <td>${i.latitude.toFixed(4)}, ${i.longitude.toFixed(4)}</td>
                            <td>${statusBadge[i.status]}</td>
                            <td>${resolutionTime}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </th:block>
</body>
</html>
